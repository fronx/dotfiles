namespace :soundcloud do
  namespace :cassandra do
    PID_FILE = File.join(RAILS_ROOT, 'tmp', 'cassandra.pid')
    
    REVISION = '0.5.0'
    CASSANDRA_HOME = File.join(RAILS_ROOT, 'vendor', 'cassandra')
    REVISION_DIR = File.join(CASSANDRA_HOME, REVISION)
    
    DIST_URL = "http://apache.mirror.iphh.net/incubator/cassandra/#{REVISION}/apache-cassandra-#{REVISION}-bin.tar.gz"
    DIST_DIR = File.join(CASSANDRA_HOME, DIST_URL.split('/').last[/.*[^\-bin\.tar\.gz]/])
    
    directory CASSANDRA_HOME
    
    file REVISION_DIR => CASSANDRA_HOME do
      sh "curl -L #{DIST_URL} | tar xz -C #{CASSANDRA_HOME}"
      sh "mv #{DIST_DIR} #{REVISION_DIR}"
      
      puts "Cassandra installed..."
    end
    
    desc "Install Cassandra Database"
    task :install => REVISION_DIR
    
    desc "Start Cassandra Database"
    task :start => [ REVISION_DIR, :java ] do
      env = ""
      
      if !ENV["CASSANDRA_INCLUDE"]
        env << "CASSANDRA_INCLUDE=#{RAILS_ROOT}/config/cassandra/cassandra.in.sh "
        env << "CASSANDRA_CONF=#{RAILS_ROOT}/config/cassandra "
        env << "CASSANDRA_HOME=#{REVISION_DIR} "
      end
      
      sh "env #{env} #{File.join(REVISION_DIR , 'bin', 'cassandra')} -p #{PID_FILE}"
      puts "Cassandra started..."
    end
    
    desc "Stop Cassandra Database"
    task :stop => [ PID_FILE ] do
      sh "kill `cat #{PID_FILE}`"
      puts "Cassandra stopped..."
    end
    
    desc "Cleaning Cassandra test data"
    task :cleanup do
      
    end
    
    desc "Check Java version"
    task :java do
      unless `java -version 2>&1`.split("\n").first =~ /java version "1.6/ #"
        puts "You need to configure your environment for Java 1.6."
        puts "If you're on OS X, just export the following environment variables:"
        puts '  JAVA_HOME="/System/Library/Frameworks/JavaVM.framework/Versions/1.6/Home"'
        puts '  PATH="/System/Library/Frameworks/JavaVM.framework/Versions/1.6/Home/bin:$PATH"'
        exit(1)
      end
    end
  end
end
